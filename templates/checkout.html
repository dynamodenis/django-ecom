{% extends 'base.html'%}
{% load static %}
{% block content%}
<div class="row">
	<div class="col-lg-6">
		<div class="box-element" id="form-wrapper">
            <form id="form">
                {% csrf_token%}
                <div id="user-info">
                    <div class="form-field">
                        <input required class="form-control" type="text" name="name" placeholder="Name..">
                    </div>
                    <div class="form-field">
                        <input required class="form-control" type="email" name="email" placeholder="Email..">
                    </div>
                </div>
                {% if order.shipping %}
                <div id="shipping-info">
                    <hr>
                    <p>Shipping Information:</p>
                    <hr>
                    <div class="form-field">
                        <input class="form-control" type="text" name="address" placeholder="Address..">
                    </div>
                    <div class="form-field">
                        <input class="form-control" type="text" name="city" placeholder="City..">
                    </div>
                    <div class="form-field">
                        <input class="form-control" type="text" name="state" placeholder="State..">
                    </div>
                    <div class="form-field">
                        <input class="form-control" type="text" name="zipcode" placeholder="Zip code..">
                    </div>
                </div>
                {% endif%}
                <hr>
                <input id="form-button" class="btn btn-success btn-block" type="submit" value="Continue">
            </form>
        </div>
		<br>
        <div class="box-element hidden" id="payment-info">
            <small>Paypal Options</small>
            <div id="paypal-button-container"></div>
            <!-- <button id="make-payment">Make Payment</button> -->
        </div>
	</div>

	<div class="col-lg-6">
		<div class="box-element">
            <a  class="btn btn-outline-dark" href="{% url 'shop:cart' %}">&#x2190; Back to Cart</a>
            <hr>
            <h3>Order Summary</h3>
            <hr>
            {% for item in items%}
                <div class="cart-row">
                    <div style="flex:2"><img class="row-image" src="{{item.product.image.url}}"></div>
                    <div style="flex:2"><p>{{item.product.name}}</p></div>
                    <div style="flex:2"><p>{{item.get_total}}</p></div>
                    <div style="flex:1"><p>{{item.quantity}}</p></div>
                </div>
            {% endfor%}
            <h5>Items:   {{order.get_order_total}}</h5>
            <h5>Total:   ${{order.get_order_price|floatformat:2}}</h5>
        </div>
	</div>
</div>

<!-- ----------------This is the paypal api integeration------------------------------- -->
<!-- Include the PayPal JavaScript SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=AUEA8T9rokdHLMWVxeSO3gOIJSd-H-mUKE2STG_YMl_R-a1Suoujo6f812Hfu9ydYtevzqP2W_D3hTCz&currency=USD"></script>

<script>

    // total amount to be payed
    var total = '{{order.get_order_price}}'


    // Render the PayPal button into #paypal-button-container
    paypal.Buttons({


        // Set up the transaction
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: parseFloat(total).toFixed(2)
                    }
                }]
            });
        },

        // Finalize the transaction
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                // Show a success message to the buyer
                submitFormData()
            });
        }


    }).render('#paypal-button-container');
</script>
<!-- ------------------------------------------------------------------------------------------------- -->
<script type="text/javascript">
    // Define the shipping from order
    var shipping = '{{order.shipping}}'
    // Get the total money for an order
    // var total = '{{order.get_order_price|floatformat:2}}'
    // Hide the shipping form if user is authnticated and digital is true
    if (user !='AnonymousUser'){
        document.getElementById('user-info').innerHTML=''
    }

    if(shipping == 'False' && user != 'AnonymousUser'){
        // Hide the entire form if user is logged in and shipping is False
        document.getElementById('form-wrapper').classList.add('hidden')
        // Only show the payment option
        document.getElementById('payment-info').classList.remove('hidden')
    }

    // Click on the make payment option
    var form = document.getElementById('form')
    // change the csrftoken from the one generated by javascript in the base html to a django generated csrf_token in the form 
    csrftoken = form.getElementsByTagName('input')[0].value
    

    form.addEventListener('submit', function(e){
        e.preventDefault()
        console.log('Sending Data')
        document.getElementById('form-button').classList.add('hidden')
        document.getElementById('payment-info').classList.remove('hidden')
    })

    // click on the make payment options
    /*document.getElementById('make-payment').addEventListener('click',function(e){
        submitFormData()
     })*/
    function submitFormData(){
        console.log('Payment Done...')
        // user data from the form
        var userFormData={
            name:'null',
            email:'null',
            total:total
        }
        // shipping form data
        var shippingFormData={
            address:'null',
            city:'null',
            state:'null',
            zipcode:'null',
        }

        // Check if shipping is True
        if( shipping != 'False'){
            shippingFormData.address = form.address.value,
            shippingFormData.city = form.city.value,
            shippingFormData.state = form.state.value,
            shippingFormData.zipcode = form.zipcode.value
        }
        // 
        if(user == 'AnonymousUser'){
            userFormData.name=form.name.value,
            userFormData.email = form.name.value
        }

        // Send the data to the backend using fetch
        var url = '/process_order/'

        fetch(url,{
            method:'POST',
            headers:{
                'Content-Type':'application/json',
                'X-CSRFToken':csrftoken,
            },
            body:JSON.stringify({'form':userFormData,'shipping':shippingFormData})
        })
        .then(response=>response.json())
        .then((data)=>{
            console.log('Data:',data),
            alert('Transaction Completed')

            // after annoymousUser makes the order set the cookie to empaty
            cart = {}
            document.cookie = 'cart='+JSON.stringify(cart)+";domain=;path=/"
            window.location.href="{% url 'shop:index'%}"
        })

    }
</script>
{% endblock%}